# OpenMeteo Service

Микросервис для сбора метеорологических данных и данных о состоянии почвы с помощью API OpenMeteo. Сервис позволяет:

1. Собирать архивные метеорологические данные с [Archive OpenMeteo API](https://archive-api.open-meteo.com/v1/archive)
2. Получать прогноз погоды с [OpenMeteo Forecast API](https://api.open-meteo.com/v1/forecast)
3. Сохранять полученные данные в MSSQL базу данных

## Описание

Сервис автоматически собирает данные метеостанций и сохраняет их в базу данных для дальнейшего использования. Сервис получает:

### Архивные данные

- Температура воздуха
- Влажность воздуха
- Скорость ветра
- Направление ветра
- Температура почвы на глубине 0-7 см и 7-28 см
- Влажность почвы на глубине 0-7 см и 7-28 см
- Осадки

### Прогноз погоды

#### Почасовые данные:
- Температура воздуха
- Влажность воздуха
- Скорость и направление ветра
- Порывы ветра
- Точка росы
- Вероятность осадков
- Количество осадков
- Температура почвы на глубине 0 см, 6 см и 18 см
- Влажность почвы на глубине 1-3 см, 3-9 см и 9-27 см

#### Ежедневные данные:
- Минимальная и максимальная температура
- Сумма осадков
- Часы с осадками
- Преобладающее направление ветра
- Максимальная скорость порывов ветра

## Архитектура

Сервис состоит из следующих компонентов:

1. **Клиент OpenMeteo API** - отправляет запросы к API OpenMeteo для получения архивных данных и прогнозов
2. **Модуль работы с БД** - сохраняет данные в MSSQL базу данных
3. **Планировщик** - запускает сбор данных с заданной периодичностью

Данные сохраняются в две таблицы:
- `OpenMeteoTelemetry` - для архивных метеорологических данных
- `OpenMeteoForecast` - для прогноза погоды

## Принцип работы

1. При первом запуске сервис загружает исторические данные за последние 365 дней (по умолчанию)
2. Затем сервис обновляет данные согласно настроенному интервалу
3. Для уже существующих метеостанций сервис ежедневно обновляет только новые данные
4. Прогноз погоды обновляется не чаще, чем раз в 3 часа

Сервис работает параллельно, одновременно получая архивные данные и прогнозы погоды для всех метеостанций.

## Установка

### Предварительные требования

- Go 1.17 или выше
- MSSQL сервер
- Доступ к API OpenMeteo

### Установка из исходников

```bash
git clone https://github.com/memrook/openMeteoAPI.git
cd openMeteoAPI
go build -o OpenMeteoService ./cmd/openmeteo
```

### Установка с помощью Docker

```bash
git clone https://github.com/memrook/openMeteoAPI.git
cd openMeteoAPI
docker build -t OpenMeteoService .
```

## Настройка

Перед запуском сервиса необходимо настроить параметры подключения к базе данных и другие параметры в файле конфигурации.

1. Скопируйте файл примера конфигурации:

```bash
cp .env.example .env
```

2. Отредактируйте файл `.env`, указав необходимые параметры:

```
# Параметры подключения к БД
DB_SERVER=your-mssql-server
DB_NAME=your-db-name
DB_LOGIN=your-login
DB_PASSWORD=your-password

# Параметры сбора данных
COLLECTION_INTERVAL=60 # Интервал сбора данных в минутах
PAST_DAYS=365 # Количество дней для загрузки исторических данных при первом запуске
FORECAST_PAST_DAYS=92 # Количество дней для загрузки прогнозных данных при первом запуске (макс. 92)
```

## Запуск

### Запуск из исходников

```bash
./openmeteo-service
```

### Запуск с помощью Docker

```bash
docker run --env-file .env openmeteo-service
```

## API документация

Сервис использует следующие API:

1. Archive OpenMeteo API: https://archive-api.open-meteo.com/v1/archive
2. OpenMeteo Forecast API: https://api.open-meteo.com/v1/forecast

## Логирование

Сервис выводит логи в стандартный вывод (stdout), включая:

- Информацию о запуске сервиса
- Сообщения о сборе данных
- Ошибки при работе с API и базой данных
- Статистику сохраненных данных

## Лицензия

[MIT License](LICENSE)

## Разработка

### Подключение к существующей системе

Сервис интегрируется с существующей системой сбора данных метеостанций, используя ту же базу данных и таблицы для хранения информации о метеостанциях. Координаты метеостанций берутся из таблицы `Stations`.

### Добавление новых метеостанций

Для добавления новой метеостанции необходимо добавить запись в таблицу `Stations` с указанием координат:

```sql
INSERT INTO Stations (ID, Label, Latitude, Longitude) 
VALUES ('station_id', 'Station Name', 55.7558, 37.6173);
``` 